<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Counter Widget - Color and Bounce</title>
    <style>
      body {
        /* ทำให้พื้นหลังโปร่งใสเมื่อใช้ใน OBS/Live Studio */
        background-color: transparent;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      #counter-container {
        font-size: 100px;
        font-weight: bold; /* ทำให้เป็นตัวหนา */
        font-family: "Arial", sans-serif;
        display: flex; /* จัดให้เนื้อหาอยู่บรรทัดเดียวกัน */
        align-items: center;
      }

      /* ใช้คลาส .dynamic-color เพื่อควบคุมสีของ X, / และ Y */
      .dynamic-color {
        transition: color 0.3s ease;
      }

      /* --- CSS Bouncing Animation --- */
      @keyframes bounce-animation {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        } /* ขยายเล็กน้อย */
        100% {
          transform: scale(1);
        }
      }

      /* คลาสที่ใช้เรียก Animation เมื่อมีการเปลี่ยนแปลงค่า */
      .bounce {
        animation: bounce-animation 0.4s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="counter-container">
      <span id="current-value" class="dynamic-color">0</span>
      <span id="separator" class="dynamic-color">/</span>
      <span id="target-value" class="dynamic-color">10</span>
    </div>

    <script>
      const API_URL = "https://servertiktokcounter.onrender.com"; // **สำคัญ:** ตรวจสอบให้ตรงกับเซิร์ฟเวอร์ของคุณ
      const CURRENT_VALUE_ELEM = document.getElementById("current-value");
      const TARGET_VALUE_ELEM = document.getElementById("target-value");
      const SEPARATOR_ELEM = document.getElementById("separator");

      // เก็บค่า X เก่าไว้ตรวจสอบการเปลี่ยนแปลง
      let lastX = 0;

      // อ้างอิงถึงทุกองค์ประกอบที่ต้องการเปลี่ยนสีพร้อมกัน
      const ALL_ELEMENTS = [
        CURRENT_VALUE_ELEM,
        TARGET_VALUE_ELEM,
        SEPARATOR_ELEM,
      ];

      function applyColor(value) {
        let color;
        if (value === 0) {
          color = "yellow"; // X = 0, สีเหลือง
        } else if (value > 0) {
          color = "lime"; // X > 0, สีเขียว
        } else {
          // value < 0
          color = "red"; // X < 0, สีแดง
        }

        // ใช้ loop เพื่อกำหนดสีให้กับทุกองค์ประกอบพร้อมกัน
        ALL_ELEMENTS.forEach((elem) => {
          elem.style.color = color;
        });
      }

      function triggerBounce() {
        // เพิ่มและลบคลาส 'bounce' เพื่อให้ Animation ทำงาน
        ALL_ELEMENTS.forEach((elem) => {
          elem.classList.remove("bounce");
          // ใช้ requestAnimationFrame หรือ setTimeout เล็กน้อยเพื่อให้เบราว์เซอร์รีเซ็ต animation ก่อนเริ่มใหม่
          void elem.offsetWidth; // บังคับให้เบราว์เซอร์รีโฟลว์
          elem.classList.add("bounce");
        });
      }

      async function updateCounter() {
        try {
          const response = await fetch(API_URL);
          const data = await response.json();

          const currentX = data.current;
          const targetY = data.target;

          // 1. ตรวจสอบ Animation
          if (currentX !== lastX) {
            // ถ้าค่า X มีการเปลี่ยนแปลง ให้เรียกใช้ Bouncing Animation
            triggerBounce();
            lastX = currentX; // อัปเดตค่าเก่า
          }

          // 2. อัปเดตค่าตัวเลข
          CURRENT_VALUE_ELEM.textContent = currentX;
          TARGET_VALUE_ELEM.textContent = targetY;

          // 3. กำหนดสี
          applyColor(currentX);
        } catch (error) {
          console.error("Failed to fetch counter data:", error);
          CURRENT_VALUE_ELEM.textContent = "Err";
          // เมื่อมี Error ให้ตั้งค่าสีเป็นเทา เพื่อแจ้งเตือน
          applyColor(null);
          ALL_ELEMENTS.forEach((elem) => {
            elem.style.color = "gray";
            elem.classList.remove("bounce");
          });
        }
      }

      // ดึงข้อมูลครั้งแรกและตั้งให้ดึงซ้ำทุก 2 วินาที (2000 มิลลิวินาที)
      updateCounter();
      setInterval(updateCounter, 2000);
    </script>
  </body>
</html>
