<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Counter Widget - MrBeast Style</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        /* ทำให้พื้นหลังโปร่งใส */
        background-color: transparent;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      /* --- สไตล์สำหรับ Change Indicator: "โดเนท 1 บาท" และ "บวก 1 ลบ" --- */
      /* ใช้คลาสรวมสำหรับสไตล์พื้นฐานของ Indicator ทุกแถว */
      .indicator-row {
        display: flex;
        margin-bottom: 2vh;
        font-family: "Prompt", sans-serif;
        font-weight: 700;
        font-size: 10vh; /* ขนาดเท่าเดิม 10vh */
        line-height: 1;
        text-shadow: -3px -3px 0 #000, 3px -3px 0 #000, -3px 3px 0 #000,
          3px 3px 0 #000;
        gap: 1.5vh;
      }

      /* สีสำหรับ "โดเนท" (ใช้สีขาวแบบ indicator-number) */
      .indicator-donate {
        color: white;
      }

      /* สีน้ำเงินสำหรับ "1 บาท" */
      .indicator-blue {
        color: #007bff;
      }

      /* สีสำหรับ "บวก" */
      .indicator-plus {
        color: #00ff7f;
        /* ลบ opacity: 0.5; ออกเพื่อให้แสดงผลเต็ม Opacity (1.0) */
        transition: opacity 0.3s ease-out;
      }
      /* สีสำหรับ "ลบ" */
      .indicator-minus {
        color: #ff4500;
        /* ลบ opacity: 0.5; ออกเพื่อให้แสดงผลเต็ม Opacity (1.0) */
        transition: opacity 0.3s ease-out;
      }
      .indicator-number {
        color: white;
        font-family: "Bebas Neue", cursive, sans-serif;
      }

      /* คลาสสำหรับกระพริบ: เมื่อมีการเปลี่ยนแปลง จะใช้ Opacity: 1.0 */
      .flash-active {
        /* เนื่องจาก Opacity เริ่มต้นเป็น 1.0 อยู่แล้ว คลาสนี้จึงไม่มีผลอะไร แต่ยังเก็บไว้เพื่อความยืดหยุ่น */
        opacity: 1 !important;
      }

      /* --- สไตล์สำหรับ Counter หลัก: "X/Y" --- */
      #counter-container {
        font-size: 20vh;
        font-weight: bold;
        font-family: "Bebas Neue", cursive, sans-serif;
        display: flex;
        align-items: center;
        line-height: 1;
      }

      .dynamic-color {
        transition: color 0.3s ease, transform 0.1s ease;
        text-shadow: -4px -4px 0 #000, 4px -4px 0 #000, -4px 4px 0 #000,
          4px 4px 0 #000, 0px 0px 10px rgba(0, 0, 0, 0.5);
      }

      /* --- CSS Bouncing Animation --- */
      @keyframes bounce-animation {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
        100% {
          transform: scale(1);
        }
      }

      .bounce {
        animation: bounce-animation 0.4s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="donate-indicator-container" class="indicator-row">
      <span class="indicator-donate">โดเนท </span>
      <span class="indicator-blue"> 1 บาท</span>
    </div>

    <div id="change-indicator-container" class="indicator-row">
      <span id="indicator-plus" class="indicator-plus">บวก</span>
      <span id="indicator-number" class="indicator-number">1</span>
      <span id="indicator-minus" class="indicator-minus">ลบ</span>
    </div>

    <div id="counter-container">
      <span id="current-value" class="dynamic-color">0</span>
      <span id="separator" class="dynamic-color">/</span>
      <span id="target-value" class="dynamic-color">10</span>
    </div>

    <script>
      // ----------------- ฟังก์ชันดึง Counter ID -----------------
      function getCounterIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id") || "default_user";
      }
      const COUNTER_ID = getCounterIdFromUrl();

      // สร้าง URL API แบบไดนามิกโดยใช้ Counter ID
      const API_URL = `https://servertiktokcounter.onrender.com/api/status?id=${COUNTER_ID}`;

      // ----------------- Elements -----------------
      const CURRENT_VALUE_ELEM = document.getElementById("current-value");
      const TARGET_VALUE_ELEM = document.getElementById("target-value");
      const SEPARATOR_ELEM = document.getElementById("separator");

      // Indicator Elements สำหรับ "บวก 1 ลบ"
      const INDICATOR_PLUS = document.getElementById("indicator-plus");
      const INDICATOR_MINUS = document.getElementById("indicator-minus");

      let lastX = 0;
      const ALL_ELEMENTS = [
        CURRENT_VALUE_ELEM,
        TARGET_VALUE_ELEM,
        SEPARATOR_ELEM,
      ];

      function applyColor(value) {
        let color;
        if (value === 0) {
          color = "#FFD700"; // X = 0, สีเหลืองทอง
        } else if (value > 0) {
          color = "#00FF7F"; // X > 0, สีเขียวมรกต
        } else {
          // value < 0
          color = "#FF4500"; // X < 0, สีส้มแดง
        }

        ALL_ELEMENTS.forEach((elem) => {
          elem.style.color = color;
        });
      }

      // ฟังก์ชันกระพริบคำว่า 'บวก' หรือ 'ลบ' ชั่วคราว
      function flashChangeIndicator(change) {
        // รีเซ็ตการกระพริบก่อน
        INDICATOR_PLUS.classList.remove("flash-active");
        INDICATOR_MINUS.classList.remove("flash-active");

        // *** ลบการตั้งค่า opacity: 0.5; ใน JS ออกแล้ว ***

        if (change > 0) {
          // ถ้าค่าเพิ่มขึ้น ให้คำว่า 'บวก' สว่างขึ้น (แต่ตอนนี้จะสว่างเต็มอยู่แล้ว)
          INDICATOR_PLUS.classList.add("flash-active");
        } else if (change < 0) {
          // ถ้าค่าลดลง ให้คำว่า 'ลบ' สว่างขึ้น (แต่ตอนนี้จะสว่างเต็มอยู่แล้ว)
          INDICATOR_MINUS.classList.add("flash-active");
        }

        // ตั้งเวลาให้คลาส flash-active ถูกลบออก (เพื่อให้ Animation เสร็จสมบูรณ์)
        setTimeout(() => {
          INDICATOR_PLUS.classList.remove("flash-active");
          INDICATOR_MINUS.classList.remove("flash-active");
        }, 400);
      }

      function triggerBounce() {
        // เพิ่มและลบคลาส 'bounce' เพื่อให้ Animation ทำงาน
        ALL_ELEMENTS.forEach((elem) => {
          elem.classList.remove("bounce");
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              elem.classList.add("bounce");
            });
          });
        });
      }

      async function updateCounter() {
        try {
          const response = await fetch(API_URL);
          const data = await response.json();

          const currentX = data.current;
          const targetY = data.target;

          const change = currentX - lastX;

          // 1. ตรวจสอบ Animation และ Indicator
          if (currentX !== lastX) {
            triggerBounce();
            flashChangeIndicator(change);
            lastX = currentX;
          }

          // 2. อัปเดตค่าตัวเลข
          CURRENT_VALUE_ELEM.textContent = currentX;
          TARGET_VALUE_ELEM.textContent = targetY;

          // 3. กำหนดสี
          applyColor(currentX);
        } catch (error) {
          console.error("Failed to fetch counter data:", error);
          CURRENT_VALUE_ELEM.textContent = "Err";
          TARGET_VALUE_ELEM.textContent = "Err";

          // เมื่อมี Error ให้ตั้งค่าสีเป็นเทา
          ALL_ELEMENTS.forEach((elem) => {
            elem.style.color = "gray";
            elem.classList.remove("bounce");
          });

          // รีเซ็ต Indicator เมื่อมี Error
          INDICATOR_PLUS.classList.remove("flash-active");
          INDICATOR_MINUS.classList.remove("flash-active");
          // *** ลบการตั้งค่า opacity: 0.5; ใน JS ออกแล้ว ***
        }
      }

      // ดึงข้อมูลครั้งแรกและตั้งให้ดึงซ้ำทุก 2 วินาที (2000 มิลลิวินาที)
      updateCounter();
      setInterval(updateCounter, 2000);
    </script>
  </body>
</html>
